{% extends 'base.html' %}

{% block title %}Search Results{% endblock %}

{% block style %}
<link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
<link href="../../static/css/result_styles.css" rel="stylesheet" />
<style>
    .form-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        padding: 20px;
    }
    .form-container fieldset {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        min-width: 200px;
    }
    .form-container legend {
        width: 100%;
        text-align: center;
        padding-bottom: 5px;
        font-weight: bold;
        color: rgb(30, 30, 30);
    }
    .custom-select {
        width: 100%;
        padding: 5px;
        border-radius: 3px;
        border: 1px solid #ccc;
    }
    input[type="radio"] {
        display: none;
    }
    .custom-button {
        display: inline-block;
        padding: 10px 20px;
        border: 2px solid #ccc;
        border-radius: 4px;
        background-color: #fff;
        color: #333;
        font-size: 14px;
        cursor: pointer;
        margin-right: 10px;
        text-align: center;
    }
    input[type="radio"]:checked + .custom-button {
        background-color: #000;
        color: #fff;
        border-color: #000;
    }
    .card {
        margin-bottom: 20px;
        max-height: 450px;
        min-height: 400px;
    }
    .card img {
        max-height: 300px;
        object-fit: cover;
    }
    fieldset legend {
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<header class="bg-light py-5">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center">
            <form id="filterForm" method="GET" action="{% url 'retailapp:search_result' %}">
                <div class="row input-group-newsletter">
                    <div class="col">
                        <input class="form-control" id="search_input" name="query" type="text" placeholder="관심있는 패션 키워드를 검색해 주세요" value="{{ query }}" />
                    </div>
                    <div class="col-auto">
                        <button type="submit" id="keyword_search" style="background-color:rgba(0, 0, 0, 0); border: none;">
                            <i class="fa-solid fa-magnifying-glass" style="height: 35px;"></i>
                        </button>
                    </div>
                </div>
                <div class="form-container">
                    <!-- 성별 선택 -->
                    <div>
                        <fieldset>
                            <legend>성별</legend>
                            <input type="radio" id="male" name="gender" value="남성" {% if gender == '남성' %}checked{% endif %}>
                            <label for="male" class="custom-button">남성</label>
                            <input type="radio" id="female" name="gender" value="여성" {% if gender == '여성' %}checked{% endif %}>
                            <label for="female" class="custom-button">여성</label>
                        </fieldset>
                    </div>
                    <!-- 플랫폼 선택 -->
                    <div>
                        <fieldset>
                            <legend>플랫폼</legend>
                            <select name="platform" id="platform" class="custom-select">
                                <option value="">모두</option>
                                <option value="musinsa" {% if platform == 'musinsa' %}selected{% endif %}>무신사</option>
                                <option value="29cm" {% if platform == '29cm' %}selected{% endif %}>29cm</option>
                                {% if gender == '여성' %}
                                <option value="ably" {% if platform == 'ably' %}selected{% endif %}>에이블리</option>
                                {% endif %}
                            </select>
                        </fieldset>
                    </div>
                    <!-- 대분류 선택 -->
                    <div>
                        <fieldset>
                            <legend>대분류</legend>
                            <select name="master_category" id="master_category" class="custom-select">
                                <option value="">선택</option>
                                {% for category in master_categories %}
                                    <option value="{{ category }}" {% if master_category == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            </select>
                        </fieldset>
                    </div>
                    <!-- 중분류 선택 -->
                    <div>
                        <fieldset>
                            <legend>중분류</legend>
                            <select name="middle_category" id="middle_category" class="custom-select">
                                <option value="">선택</option>
                                {% for category in middle_categories %}
                                    <option value="{{ category }}" {% if middle_category == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            </select>
                        </fieldset>
                    </div>
                    <!-- 소분류 선택 -->
                    <div>
                        <fieldset>
                            <legend>소분류</legend>
                            <select name="small_category" id="small_category" class="custom-select">
                                <option value="">선택</option>
                                {% for category in small_categories %}
                                    <option value="{{ category }}" {% if small_category == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            </select>
                        </fieldset>
                    </div>
                </div>
            </form>
        </div>
    </div>
</header>
<section class="py-5">
    {% if products %}
        <div class="container px-4 px-lg-5 mt-5">
            <div class="row gx-4 gx-lg-5 row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5">
                {% for product in products %}
                    <div class="col mb-5">
                        <div class="card h-100">
                            <img class="card-img-top" src="{{ product.img_url }}" alt="{{ product.product_name }}" />
                            <p><span class="fw-bolder">{{ product.platform }}</span></p>
                            <div class="card-body p-4 text-center">
                                <h5 class="fw-bolder">{{ product.product_name }}</h5>
                                <p>{{ product.brand_name_kr }} ({{ product.brand_name_en }})</p>
                                <p>
                                    <span class="text-muted text-decoration-line-through">{{ product.original_price }}원</span>
                                    <span class="fw-bolder">{{ product.final_price }}원</span>
                                </p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <p class="text-center">검색 결과가 없습니다.</p>
    {% endif %}
</section>
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const genderInputs = document.querySelectorAll('input[name="gender"]');
        const platformSelect = document.getElementById('platform');
        const masterCategorySelect = document.getElementById('master_category');
        const middleCategorySelect = document.getElementById('middle_category');
        const smallCategorySelect = document.getElementById('small_category');

        const categoryData = {
            "남성": {
                "아우터": ["재킷", "코트", "패딩", "플리스", "기타"],
                "상의": ["티셔츠", "셔츠", "니트"],
                "하의": ["팬츠"],
                "신발": ["전체"]
            },
            "여성": {
                "아우터": ["재킷", "플리스", "코트", "패딩", "기타"],
                "상의": ["티셔츠", "셔츠", "블라우스", "니트"],
                "하의": ["팬츠", "원피스", "스커트"],
                "신발": ["전체"]
            }
        };

        const updatePlatformOptions = (gender, selectedPlatform) => {
            // 플랫폼 옵션을 서버에서 렌더링하므로 JavaScript에서 다시 설정하지 않음
            // 필요 시, 동적으로 추가할 수 있음
        };

        const updateCategories = (gender, selectedMaster, selectedMiddle, selectedSmall) => {
            // 대분류 업데이트
            masterCategorySelect.innerHTML = '<option value="">선택</option>';
            Object.keys(categoryData[gender]).forEach((masterCategory) => {
                const isSelected = masterCategory === selectedMaster ? 'selected' : '';
                masterCategorySelect.innerHTML += `<option value="${masterCategory}" ${isSelected}>${masterCategory}</option>`;
            });

            // 중분류 업데이트
            if (selectedMaster && categoryData[gender][selectedMaster]) {
                middleCategorySelect.innerHTML = '<option value="">선택</option>';
                categoryData[gender][selectedMaster].forEach((middleCategory) => {
                    const isSelected = middleCategory === selectedMiddle ? 'selected' : '';
                    middleCategorySelect.innerHTML += `<option value="${middleCategory}" ${isSelected}>${middleCategory}</option>`;
                });
            } else {
                middleCategorySelect.innerHTML = '<option value="">선택</option>';
            }

            // 소분류 업데이트
            if (selectedMiddle) {
                smallCategorySelect.innerHTML = '<option value="">선택</option>';
                // 실제 소분류 데이터를 여기에 추가하세요. 예시로 세부1, 세부2 사용
                // 소분류 데이터가 더 있다면 서버에서 전달받아 사용
                const smallCategories = ["세부1", "세부2"];
                smallCategories.forEach((smallCategory) => {
                    const isSelected = smallCategory === selectedSmall ? 'selected' : '';
                    smallCategorySelect.innerHTML += `<option value="${smallCategory}" ${isSelected}>${smallCategory}</option>`;
                });
            } else {
                smallCategorySelect.innerHTML = '<option value="">선택</option>';
            }
        };

        const handleSelectChange = () => {
            const selectedGender = document.querySelector('input[name="gender"]:checked')?.value || '남성';
            const platformValue = platformSelect.value;
            const masterCategoryValue = masterCategorySelect.value;
            const middleCategoryValue = middleCategorySelect.value;
            const smallCategoryValue = smallCategorySelect.value;

            console.log({ selectedGender, platformValue, masterCategoryValue, middleCategoryValue, smallCategoryValue });
            // 추가 동작 구현 (예: AJAX 요청)
        };

        genderInputs.forEach((input) => {
            input.addEventListener('change', () => {
                const selectedGender = document.querySelector('input[name="gender"]:checked')?.value || '남성';
                updateCategories(selectedGender, '', '', '');
                handleSelectChange();
            });
        });

        platformSelect.addEventListener('change', handleSelectChange);
        masterCategorySelect.addEventListener('change', () => {
            const selectedGender = document.querySelector('input[name="gender"]:checked')?.value || '남성';
            const selectedMaster = masterCategorySelect.value;
            updateCategories(selectedGender, selectedMaster, '', '');
            handleSelectChange();
        });
        middleCategorySelect.addEventListener('change', () => {
            const selectedGender = document.querySelector('input[name="gender"]:checked')?.value || '남성';
            const selectedMaster = masterCategorySelect.value;
            const selectedMiddle = middleCategorySelect.value;
            updateCategories(selectedGender, selectedMaster, selectedMiddle, '');
            handleSelectChange();
        });
        smallCategorySelect.addEventListener('change', handleSelectChange);

        // 초기화
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('query') || '';
        const gender = urlParams.get('gender') || '남성';
        const platform = urlParams.get('platform') || '';
        const master_category = urlParams.get('master_category') || '';
        const middle_category = urlParams.get('middle_category') || '';
        const small_category = urlParams.get('small_category') || '';

        document.getElementById('search_input').value = query;
        document.getElementById(gender === '남성' ? 'male' : 'female').checked = true;
        updateCategories(gender, master_category, middle_category, small_category);
        handleSelectChange();
    });
</script>
