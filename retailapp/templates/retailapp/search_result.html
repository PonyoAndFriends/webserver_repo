{% extends 'base.html' %}

{% block title %}Search Results{% endblock %}

{% block style %}
<link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
<link href="../../static/css/result_styles.css" rel="stylesheet" />
<style>
    .form-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        padding: 20px;
    }
    .form-container fieldset {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        min-width: 200px;
    }
    .form-container legend {
        width: 100%;
        text-align: center;
        padding-bottom: 5px;
        font-weight: bold;
        color: rgb(30, 30, 30);
    }
    .custom-select {
        width: 100%;
        padding: 5px;
        border-radius: 3px;
        border: 1px solid #ccc;
    }
    input[type="radio"] {
        display: none;
    }
    .custom-button {
        display: inline-block;
        padding: 10px 20px;
        border: 2px solid #ccc;
        border-radius: 4px;
        background-color: #fff;
        color: #333;
        font-size: 14px;
        cursor: pointer;
        margin-right: 10px;
        text-align: center;
    }
    input[type="radio"]:checked + .custom-button {
        background-color: #000;
        color: #fff;
        border-color: #000;
    }
    .card {
        margin-bottom: 20px;
        max-height: 450px;
        min-height: 400px;
    }
    .card img {
        max-height: 300px;
        object-fit: cover;
    }
    fieldset {
        border: none; /* 기본 테두리 제거 */
        margin: 0; /* 기본 마진 제거 */
        padding: 0;
        height: 100px;
    }
    .search_input {
        width: 80%;
        height: 50px;
        margin-left: 100px;
        border-radius: 0px;
        border-width: 0 0 2px;
        border-color: #000;
    }
    legend{
        font-size: small;
    }
    .video_youtube {
        display: none;
        text-align: center;
        border: #000 1px solid;
        overflow: hidden;
    }
    /* 팝업 스타일 */
    #review-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        z-index: 1001;
        width: 50%; /* 팝업 너비 조정 */
        max-width: 600px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* 리뷰 내용 스타일 */
    #review-content {
        max-height: 300px; /* 최대 높이 설정 */
        overflow-y: auto; /* 스크롤 가능 */
        margin-top: 10px;
        border: 1px solid #ddd;
        padding: 10px;
        background-color: #f9f9f9;
    }

    /* 오버레이 스타일 */
    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<header class="py-3">
    <div class="container px-4 px-lg-5 my-5">
        <div class="text-center">
            <form id="filterForm" method="GET" action="{% url 'retailapp:search_result' %}">
                <div class="row input-group-newsletter" style="width: 1000px; text-align: center;">
                    <div class="text_input" style="width: 500px; margin: 0 auto; text-align: center;">
                        <input class="form-control search_input" id="search_input" name="query" type="text" placeholder="관심있는 패션 키워드를 검색해 주세요" style="margin: 0 auto; width: 750px; height: 50px;" value="{{ query }}" />
                    </div>
                    <div class="col-auto" style="text-align: left;">
                        <button type="submit" id="keyword_search" style="margin: auto; background-color:rgba(0, 0, 0, 0); border: none;">
                            <i class="fa-solid fa-magnifying-glass" style="width: auto; height: 35px;"></i>
                        </button>
                    </div>
                </div>
                <div class="form-container">
                    <!-- 성별 선택 -->
                    <div>
                        <fieldset>
                            <legend>성별</legend>
                            <input type="radio" id="male" name="gender" value="남성" {% if gender == '남성' %}checked{% endif %}>
                            <label for="male" class="custom-button">남성</label>
                            <input type="radio" id="female" name="gender" value="여성" {% if gender == '여성' %}checked{% endif %}>
                            <label for="female" class="custom-button">여성</label>
                        </fieldset>
                    </div>
                    <!-- 플랫폼 선택 -->
                    <div>
                        <fieldset>
                            <legend>플랫폼</legend>
                            <select name="platform" id="platform" class="custom-select">
                                <option value="">모두</option>
                                <option value="musinsa" {% if platform == 'musinsa' %}selected{% endif %}>무신사</option>
                                <option value="29cm" {% if platform == '29cm' %}selected{% endif %}>29CM</option>
                                {% if gender == "여성" %}
                                    <option value="ably" {% if platform == 'ably' %}selected{% endif %}>에이블리</option>
                                {% endif %}
                            </select>
                        </fieldset>
                    </div>
                    <!-- 대분류 선택 -->
                    <div>
                        <fieldset>
                            <legend>대분류</legend>
                            <select name="master_category" id="master_category" class="custom-select">
                                <option value="">선택</option>
                                {% for category in master_categories %}
                                    <option value="{{ category }}" {% if master_category == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            </select>
                        </fieldset>
                    </div>
                    <!-- 중분류 선택 -->
                    <div>
                        <fieldset>
                            <legend>중분류</legend>
                            <select name="middle_category" id="middle_category" class="custom-select">
                                <option value="">선택</option>
                                {% for category in middle_categories %}
                                    <option value="{{ category }}" {% if middle_category == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            </select>
                        </fieldset>
                    </div>
                    <!-- 소분류 선택 -->
                    <div>
                        <fieldset>
                            <legend>소분류</legend>
                            <select name="small_category" id="small_category" class="custom-select">
                                <option value="">선택</option>
                            </select>                            
                        </fieldset>
                    </div>
                    <!-- 정렬 선택 (제거됨) -->
                    <!--
                    <div>
                        <fieldset>
                            <legend>정렬</legend>
                            <select name="sort" id="sort" class="custom-select">
                                <option value="">기본</option>
                                <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>가격: 낮은 순</option>
                                <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>가격: 높은 순</option>
                                <option value="popularity" {% if sort == 'popularity' %}selected{% endif %}>인기 순</option>
                                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>최신 순</option>
                            </select>
                        </fieldset>
                    </div>
                    -->
                </div>
            </form>
        </div>
    </div>
    <div class="video_youtube">

    </div>
</header>
<section class="py-5">
    {% if products %}
        <div class="container px-4 px-lg-5 mt-5" style="margin-bottom: 20px;">
            <div class="row gx-4 gx-lg-5 row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5">
                {% for product in products %}
                    <div class="col mb-6" style="margin-bottom: 20px;" onclick="loadReviews('{{ product.product_id }}', '{{ product.img_url }}', '{{ product.product_name }}')">
                        <div class="card h-100" style="margin-bottom: 10px; margin-top:20px; ">
                            <img class="card-img-top" style="height: 200px; margin-bottom: 20px; " src="{{ product.img_url }}" alt="{{ product.product_name }}" />
                            <p style="margin: 5px;"><span class="fw-bolder" style="margin-left: 20px;">{{ product.ranking }}위</span></p>
                            <div class="card-body text-center" style="padding-top: 0;">
                                <p><span class="fw-bolder" style="color: #555;">{{ product.platform }}</span></p>
                                <h6 class="fw-bolder">
                                    {% if product.product_name|length <= 12 %}
                                        {{ product.product_name }}
                                    {% else %}
                                        {{ product.product_name|slice:":12" }}...
                                    {% endif %}
                                </h6>
                                <p>{{ product.brand_name_kr }}</p>
                                <p>
                                    <span class="text-muted text-decoration-line-through">{{ product.original_price }}원</span>
                                    <span class="fw-bolder">{{ product.final_price }}원</span>
                                </p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <h4 class="text-center">검색 결과가 없습니다.</h4>
    {% endif %}
</section>

<!-- 팝업 오버레이 -->
<div id="overlay" onclick="closePopup()"></div>

<!-- 리뷰 팝업 -->
<div id="review-popup">
    <button style="float: right; border-width:0px;" onclick="closePopup()"><i class="fa-solid fa-xmark"></i></button>
    <h2>Reviews</h2>
    <!-- 리뷰를 표시하는 영역 -->
    <div id="review-content"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    function loadReviews(product_id, img_url, product_name) {
        $.ajax({
            url: "{% url 'retailapp:search_result/get_product_reviews_with_cache' %}",  // Django URL Reverse 사용
            data: { product_id: product_id }, // productId 전달
            success: function(data) {
                // 팝업과 오버레이 표시
                $("#overlay").show();
                $("#review-popup").show();

                // 리뷰 데이터 표시
                let content = "";
                if (data.length === 0) {
                    content = "<p>No reviews found.</p>";
                } else {
                    content = data.map(function(review) {
                        return `
                            <div>
                                <div style="text-align: center;">
                                    <img src="${img_url}" alt="${product_name}" style="max-width: 100px;">
                                </div>
                                <p>${review.platform}</p>
                                <h3>${product_name}</h3>
                                <p><strong>Rating:</strong> ${review.review_rating}</p>
                                <p><strong>Content:</strong> ${review.review_content}</p>
                                <p><strong>Date:</strong> ${review.review_date}</p>
                            </div>
                            <hr>
                        `;
                    }).join("");
                }
                $("#review-content").html(content);

                // 스크롤 위치를 맨 위로 설정
                $("#review-content").scrollTop(0);
            },
            error: function() {
                alert("Error loading reviews.");
            }
        });
    }

    // 팝업 닫기
    function closePopup() {
        $("#overlay").hide();
        $("#review-popup").hide();
    }

    document.addEventListener("DOMContentLoaded", function () {
        // 필드 가져오기
        const genderFields = document.getElementsByName("gender");
        const platformField = document.getElementById("platform");
        const masterCategoryField = document.getElementById("master_category");
        const middleCategoryField = document.getElementById("middle_category");
        const smallCategoryField = document.getElementById("small_category");
        // const sortField = document.getElementById("sort"); // 정렬 필드 제거

        // 대분류와 중분류를 위한 데이터
        const categoryData = {
            "남성": {
                "아우터": ["재킷", "코트", "패딩", "플리스", "기타"],
                "상의": ["티셔츠", "셔츠", "니트"],
                "하의": ["팬츠"],
                "신발": ["전체"],
            },
            "여성": {
                "아우터": ["재킷", "플리스", "코트", "패딩", "기타"],
                "상의": ["티셔츠", "셔츠", "블라우스", "니트"],
                "하의": ["팬츠", "원피스", "스커트"],
                "신발": ["전체"],
            },
        };

        // 대분류와 중분류 업데이트
        function updateCategories(selectedGender, selectedMaster, selectedMiddle) {
            // 대분류 필드 업데이트
            masterCategoryField.innerHTML = '<option value="">선택</option>';
            Object.keys(categoryData[selectedGender]).forEach(function(masterCategory) {
                const isSelected = masterCategory === selectedMaster ? "selected" : "";
                masterCategoryField.innerHTML += `<option value="${masterCategory}" ${isSelected}>${masterCategory}</option>`;
            });

            // 중분류 필드 업데이트
            middleCategoryField.innerHTML = '<option value="">선택</option>';
            if (selectedMaster && categoryData[selectedGender][selectedMaster]) {
                categoryData[selectedGender][selectedMaster].forEach(function(middleCategory) {
                    const isSelected = middleCategory === selectedMiddle ? "selected" : "";
                    middleCategoryField.innerHTML += `<option value="${middleCategory}" ${isSelected}>${middleCategory}</option>`;
                });
            }
        }

        // 소분류 필드를 업데이트하는 함수
function updateSmallCategories() {
    const gender = Array.from(genderFields).find(input => input.checked)?.value || "남성";
    const platform = platformField.value;
    const catDepth2 = masterCategoryField.value;
    const catDepth3 = middleCategoryField.value;

    // 소분류를 가져오기 위한 API 요청
    if (catDepth2 && catDepth3) {
        fetch(`/retailapp/get-small-categories/?gender=${gender}&platform=${platform}&master_category=${catDepth2}&middle_category=${catDepth3}`)
            .then(response => response.json())
            .then(data => {
                // 소분류 선택 필드 업데이트
                smallCategoryField.innerHTML = '<option value="">선택</option>';
                data.forEach(function(category) {
                    smallCategoryField.innerHTML += `<option value="${category}">${category}</option>`;
                });
            })
            .catch(error => console.error("Error fetching small categories:", error));
    } else {
        smallCategoryField.innerHTML = '<option value="">선택</option>';
    }
}

        // 필드 변경 시 동작
        function handleFieldChange() {
            const selectedGender = Array.from(genderFields).find(input => input.checked)?.value || "남성";
            const selectedMaster = masterCategoryField.value;
            const selectedMiddle = middleCategoryField.value;
            // const selectedSort = sortField.value; // 정렬 필드 제거

            // 대분류와 중분류 업데이트
            updateCategories(selectedGender, selectedMaster, selectedMiddle);

            // 소분류 업데이트
            updateSmallCategories();

            console.log({
                gender: selectedGender,
                platform: platformField.value,
                masterCategory: selectedMaster,
                middleCategory: selectedMiddle,
                // sort: selectedSort, // 정렬 필드 제거
            });
        }

        // 초기화
        function initialize() {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get("query") || "";
            const gender = urlParams.get("gender") || "남성";
            const platform = urlParams.get("platform") || "";
            const masterCategory = urlParams.get("master_category") || "";
            const middleCategory = urlParams.get("middle_category") || "";
            // const sort = urlParams.get("sort") || ""; // 정렬 필드 제거

            // 플랫폼 초기화
            platformField.value = platform;

            // 대분류와 중분류 초기화
            updateCategories(gender, masterCategory, middleCategory);

            // 소분류 초기화
            updateSmallCategories();

            // 정렬 필드 초기화 (제거됨)
            // sortField.value = sort;

            console.log("Initialized with:", {
                gender,
                platform,
                masterCategory,
                middleCategory,
                // sort,
            });
        }

        // 이벤트 리스너 추가
        Array.from(genderFields).forEach(function(input) {
            input.addEventListener("change", handleFieldChange);
        });
        platformField.addEventListener("change", handleFieldChange);
        masterCategoryField.addEventListener("change", handleFieldChange);
        middleCategoryField.addEventListener("change", handleFieldChange);
        // sortField.addEventListener("change", handleFieldChange); // 정렬 필드 제거

        // 실행
        initialize();
    });
</script>

{% endblock %}
